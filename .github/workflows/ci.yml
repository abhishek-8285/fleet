name: Fleet Ultimate CI
on: [push, pull_request]

jobs:
  secure-check:
    runs-on: self-hosted
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 1. SECRET SCANNING (Smarter Check)
      - name: ðŸ•µï¸ Check for Secrets
        run: |
          echo "Scanning for hardcoded credentials (excluding placeholders)..."
          # 1. Exclude .github and look for keys longer than 15 chars that aren't variables
          # This looks for KEY=VALUE where VALUE is not starting with $ and is long
          # Note: [A-Za-z0-9/+=]{20,} is a common pattern for AWS/Base64 keys
          LEAKS=$(grep -rE "(=|\"|')[A-Za-z0-9/+=]{20,}(\"|')?" . \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude=package-lock.json \
            | grep -vE "your_aws_access_key|your_aws_key" || true)

          if [ ! -z "$LEAKS" ]; then
            echo "âŒ CRITICAL: Potential Secrets found in code:"
            echo "$LEAKS"
            exit 1
          else
            echo "âœ… No obvious secrets found."
          fi

      # 2. VULNERABILITY SCAN (Trivy)
      - name: ðŸ›¡ï¸ Security Scan (Trivy)
        run: |
          if ! command -v trivy &> /dev/null; then
             curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          fi
          trivy fs . --scanners vuln,secret,config --exit-code 1 --severity CRITICAL
