name: Fleet Monorepo CI
on: [push, pull_request]

jobs:
  # 1. SECURITY & LINT (Parallel)
  security-and-lint:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Trivy Security Scan
        run: |
          trivy fs . --scanners vuln,secret --severity CRITICAL --exit-code 1

      - name: ğŸ” Backend Lint (Go)
        run: |
          cd backend
          # Pre-installing is faster, but adding timeout for execution
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          # Increased timeout to 10m for Pova hardware
          $(go env GOPATH)/bin/golangci-lint run --timeout 10m ./...

  # 2. BUILD & TEST BACKEND
  backend-gate:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Generate Proto & Build
        run: |
          cd backend
          make install-tools
          make gen-proto
          make build

      - name: ğŸ§ª Unit Tests & Coverage
        run: |
          cd backend
          # Run tests with cross-package coverage for core internal logic
          go test -v -coverpkg=./internal/handlers/...,./internal/services/... -coverprofile=coverage.out -timeout 15m ./...
          
          # Enforce 10% initial threshold (increase this as you add tests!)
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Core Logic Coverage: $COVERAGE%"
          
          # Robust threshold check using awk
          awk -v cov="$COVERAGE" 'BEGIN { if (cov < 10) { print "âŒ Coverage " cov "% is below required 10% threshold!"; exit 1 } }'
          echo "âœ… Coverage check passed"

  # 3. BUILD FRONTEND (Dashboard)
  frontend-dashboard:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      - name: ğŸ—ï¸ Build Dashboard
        run: |
          cd frontend/dashboard
          npm ci --prefer-offline
          npm run build

  # 4. BUILD FRONTEND (Portal)
  frontend-portal:
    needs: security-and-lint
    runs-on: self-hosted
    env:
      NEXT_TELEMETRY_DISABLED: 1
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      - name: ğŸ—ï¸ Build Portal
        run: |
          cd frontend/portal
          npm ci --prefer-offline
          npm run build
