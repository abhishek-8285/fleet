name: Fleet Monorepo CI
on: [push, pull_request]

jobs:
  # 1. SECURITY & LINT (Parallel)
  security-and-lint:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Trivy Security Scan
        run: |
          trivy fs . --scanners vuln,secret --severity CRITICAL --exit-code 1

      - name: ğŸ” Backend Lint (Go)
        run: |
          cd backend
          # Pre-installing is faster, but adding timeout for execution
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          # Increased timeout to 10m for Pova hardware
          $(go env GOPATH)/bin/golangci-lint run --timeout 10m ./...

  # 2. BUILD & TEST BACKEND
  backend-gate:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Generate Proto & Build
        run: |
          cd backend
          # Ensure tools are in PATH
          export PATH=$PATH:$(go env GOPATH)/bin
          make gen-proto
          make build

      - name: ğŸ§ª Unit Tests
        run: |
          cd backend
          go test -race -v -timeout 15m ./...

  # 3. BUILD FRONTEND (Dashboard)
  frontend-dashboard:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      - name: ğŸ—ï¸ Build Dashboard
        run: |
          cd frontend/dashboard
          npm install
          npm run build

  # 4. BUILD FRONTEND (Portal)
  frontend-portal:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      - name: ğŸ—ï¸ Build Portal
        run: |
          cd frontend/portal
          npm install
          npm run build
