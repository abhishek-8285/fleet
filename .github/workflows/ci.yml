name: Fleet Monorepo CI
on: [push, pull_request]

jobs:
  # 1. SECURITY & LINT (Parallel)
  security-and-lint:
    runs-on: self-hosted
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Trivy Security Scan
        run: |
          trivy fs . --scanners vuln,secret --severity CRITICAL --exit-code 1

      - name: üîç Backend Lint (Go)
        run: |
          cd backend
          # Pre-installing is faster, but adding timeout for execution
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          # Increased timeout to 10m for Pova hardware
          $(go env GOPATH)/bin/golangci-lint run --timeout 10m ./...

  # 2. BUILD & TEST BACKEND
  backend-gate:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Generate Proto & Build
        run: |
          cd backend
          make install-tools
          make gen-proto
          make build

      - name: üß™ Unit Tests & Coverage
        run: |
          cd backend
          # Run tests with cross-package coverage for core internal logic
          go test -v -coverpkg=./internal/handlers/...,./internal/services/... -coverprofile=coverage.out -timeout 15m ./...
          
          # 1. GLOBAL COVERAGE GATE (Core Logic)
          GLOBAL_COV=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Global Core Logic Coverage: $GLOBAL_COV%"
          awk -v cov="$GLOBAL_COV" 'BEGIN { if (cov < 10) { print "‚ùå Global coverage " cov "% is below 10%"; exit 1 } }'
          
          # 2. INCREMENTAL (PR) COVERAGE GATE
          # Compare against master to find changed Go files in backend/
          # Ensure origin/master is fetched if not already
          git fetch origin master --quiet
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD | grep '^backend/.*\.go$' | sed 's|^backend/||' || true)
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Modified Go files in this PR:"
            echo "$CHANGED_FILES"
            
            TOTAL_PATCH_COV=0
            PATCH_FILE_COUNT=0
            
            for FILE in $CHANGED_FILES; do
              [ ! -f "$FILE" ] && continue # Skip deleted files
              
              FILE_COV=$(go tool cover -func=coverage.out | grep "$FILE" | awk '{print $3}' | sed 's/%//' || echo "")
              if [ -n "$FILE_COV" ]; then
                echo "Coverage for $FILE: $FILE_COV%"
                TOTAL_PATCH_COV=$(awk "BEGIN {print $TOTAL_PATCH_COV + $FILE_COV}")
                PATCH_FILE_COUNT=$((PATCH_FILE_COUNT + 1))
              fi
            done
            
            if [ "$PATCH_FILE_COUNT" -gt 0 ]; then
              AVG_PATCH_COV=$(awk -v t="$TOTAL_PATCH_COV" -v c="$PATCH_FILE_COUNT" 'BEGIN { print t / c }')
              echo "Average Incremental Coverage: $AVG_PATCH_COV%"
              
              # Require 80% for modified code
              awk -v cov="$AVG_PATCH_COV" 'BEGIN { if (cov < 80) { print "‚ùå PR Incremental Coverage " cov "% is below 80%"; exit 1 } }'
            fi
          else
            echo "No Go files modified in this PR. Skipping incremental check."
          fi
          echo "‚úÖ All coverage gates passed"

  # 3. BUILD FRONTEND (Dashboard)
  frontend-dashboard:
    needs: security-and-lint
    runs-on: self-hosted
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      - name: üèóÔ∏è Build Dashboard
        run: |
          cd frontend/dashboard
          npm ci --prefer-offline
          npm run build

  # 4. BUILD FRONTEND (Portal)
  frontend-portal:
    needs: security-and-lint
    runs-on: self-hosted
    env:
      NEXT_TELEMETRY_DISABLED: 1
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      - name: üèóÔ∏è Build Portal
        run: |
          cd frontend/portal
          npm ci --prefer-offline
          npm run build
