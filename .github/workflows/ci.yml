name: Fleet Ultimate CI
on: [push, pull_request]

jobs:
  secure-check:
    runs-on: self-hosted
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 1. SECURITY SCAN (Trivy - Professional Grade)
      - name: ðŸ›¡ï¸ Security & Secret Scan
        run: |
          echo "Installing/Updating Trivy Security Scanner..."
          if ! command -v trivy &> /dev/null; then
             curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          fi
          
          echo "Running Security Audit (Detecting real secrets and CVEs)..."
          # We use Trivy's built-in 'secret' scanner which is much smarter than grep.
          # It ignores binary files and common false positives automatically.
          trivy fs . \
            --scanners vuln,secret \
            --exit-code 1 \
            --severity CRITICAL,HIGH \
            --hide-progress \
            --format table
