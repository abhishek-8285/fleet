name: Fleet Ultimate CI
on: [push, pull_request]

jobs:
  # STAGE 1: QUALITY & SECURITY
  secure-check:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 1. SECRET SCANNING (Don't leak API Keys)
      - name: ğŸ•µï¸ Check for Secrets
        run: |
          # Simple grep check for common leaks (AWS, Private Keys)
          if grep -rE "AWS_ACCESS_KEY_ID|BEGIN RSA PRIVATE KEY" .; then
            echo "âŒ CRITICAL: Potential Secrets found in code!"
            exit 1
          fi

      # 2. VULNERABILITY SCAN (Trivy)
      - name: ğŸ›¡ï¸ Security Scan (Trivy)
        run: |
          # Install Trivy (Lightweight Security Scanner)
          if ! command -v trivy &> /dev/null; then
             curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          fi
          # Scan filesystem for known CVEs
          trivy fs . --scanners vuln,secret,config --exit-code 1 --severity CRITICAL,HIGH

  # STAGE 2: BUILD & TEST
  build-release:
    needs: secure-check
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§ª Run Unit Tests
        run: go test -race -v ./...

      - name: ğŸ—ï¸ Compile Binary
        run: go build -o fleet-server ./cmd/server/main.go || go build -o fleet-server .

      # 3. ARTIFACT UPLOAD (Save the binary)
      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fleet-server-arm64
          path: fleet-server
          retention-days: 5

      # 4. NOTIFICATION (Optional - Slack/Discord)
      # - name: ğŸ”” Notify Failure
      #   if: failure()
      #   run: curl -X POST -H 'Content-type: application/json' --data '{"text":"âŒ Build Failed on Pova!"}' ${{ secrets.SLACK_WEBHOOK }}
